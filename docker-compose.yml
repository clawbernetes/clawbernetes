# Clawbernetes Docker Compose
# Quick local development and testing

services:
  # ===========================================
  # Gateway (Control Plane)
  # ===========================================
  gateway:
    build:
      context: .
      target: gateway
    container_name: claw-gateway
    ports:
      - "8080:8080"
    environment:
      - RUST_LOG=info
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "8080"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  # ===========================================
  # Node 1 (Simulated)
  # ===========================================
  node1:
    build:
      context: .
      target: node
    container_name: claw-node-1
    environment:
      - CLAWNODE_GATEWAY=ws://gateway:8080
      - CLAWNODE_NAME=node-1
      - RUST_LOG=info
    depends_on:
      gateway:
        condition: service_healthy
    restart: unless-stopped

  # ===========================================
  # Node 2 (Simulated)
  # ===========================================
  node2:
    build:
      context: .
      target: node
    container_name: claw-node-2
    environment:
      - CLAWNODE_GATEWAY=ws://gateway:8080
      - CLAWNODE_NAME=node-2
      - RUST_LOG=info
    depends_on:
      gateway:
        condition: service_healthy
    restart: unless-stopped

  # ===========================================
  # CLI (for interactive use)
  # ===========================================
  cli:
    build:
      context: .
      target: cli
    container_name: claw-cli
    environment:
      - CLAWBERNETES_GATEWAY=ws://gateway:8080
    depends_on:
      gateway:
        condition: service_healthy
    profiles:
      - tools
    stdin_open: true
    tty: true

# ===========================================
# GPU Node (requires nvidia-container-toolkit)
# ===========================================
# Uncomment to use:
#
#   gpu-node:
#     build:
#       context: .
#       dockerfile: Dockerfile.gpu
#     container_name: claw-gpu-node
#     environment:
#       - CLAWNODE_GATEWAY=ws://gateway:8080
#       - CLAWNODE_NAME=gpu-node
#       - RUST_LOG=info
#     depends_on:
#       gateway:
#         condition: service_healthy
#     deploy:
#       resources:
#         reservations:
#           devices:
#             - driver: nvidia
#               count: all
#               capabilities: [gpu]
#     restart: unless-stopped

networks:
  default:
    name: clawbernetes
